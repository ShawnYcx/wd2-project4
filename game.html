<!DOCTYPE html>
<html>


<head>
	<title> Pong </title>
	<link href="css/styles.css" rel="stylesheet">
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	
</head>

<body onload="setup()">
  <div id="game-board">
    <canvas id="canvas" width="500" height="375" tabeindex='1'>Your browser doesn't support Canvas</canvas>
  </div>
  <audio preload="true" id="collide">
  	<source src="http://dl.dropbox.com/u/26141789/canvas/pingpong/Metal%20Cling%20-%20Hit.mp3" />
  	<source src="http://dl.dropbox.com/u/26141789/canvas/pingpong/Metal%20Cling%20-%20Hit.wav" />
  </audio>

</body>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
	function setup() {

		var socket = io();
		var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var H = canvas.height;
        var W = canvas.width;
        var p1win = 0;
        var p2win = 0;
        var raf;
        var playerid;
        var velocity_array = [-8,-6,-5-4,-3,3,4,5,6,8];
        var rand_velo_x = velocity_array[Math.floor(Math.random() * velocity_array.length)];
        var rand_velo_y = velocity_array[Math.floor(Math.random() * velocity_array.length)];


        var ball = {
          x: W/2,
          y: H/2, 
          r: 7,
          c: "black",
          vx: 1,
          vy: -1,
          
          // Function for drawing ball on canvas
          draw: function() {
            context.beginPath();
            context.fillStyle = this.c;
            context.arc(this.x , this.y , this.r, 0, Math.PI*2, false);
            this.x += this.vx;
            this.y += this.vy;
            collide(ball, paddle, paddle2);
            if(this.vy == 0 && this.vx == 0)
            {
              this.x = W/2;
              this.y = H/2;
              this.vx = 1;
              this.vy = -1;
            }
            context.fill();
            //context.stroke();
            context.closePath();
          }
        };

        var paddle = {
          x: -10,
          y: 10,
          vx: 0,
          vy: 0,
          width: 175,
          height: 20,
          draw: function() {
          	//context.clearRect(0,0, canvas.width, canvas.height);
          	context.beginPath();
            context.rect(this.x, this.y, this.width, this.height);
            context.stroke();
            context.closePath();

            //context.restore();
          }
        };
        var paddle2 = {
          x: 5,
          y: H - 30,
          vx: 0,
          vy: 0,
          width: 175,
          height: 20,
          draw: function() {
            //context.clearRect(0,0, canvas.width, canvas.height);
            context.beginPath();
            context.rect(this.x, this.y, this.width, this.height);
            context.stroke();
            context.closePath();

            //context.restore();
          }
        };

        // socket.on('start', function(start) {
        // 	//stuff
        // });


        raf = window.requestAnimationFrame(draw);

        function draw() {
          context.clearRect(0,0, canvas.width, canvas.height);
 
            paddle.draw();
            paddle2.draw();
            ball.draw();
            socket.emit('moveBall', ball);
            raf = window.requestAnimationFrame(draw);

        }

        function collide(b, p1, p2) {
          if(b.y + b.r >= p2.y && b.y + b.r <= p2.y + p2.height) {
            if(b.x >= p2.x && b.x <= p2.x + p2.width && b.vy > 0){
              b.vy *= -1;
            }
          }
          else if(b.y - b.r >= p1.y && b.y - b.r <= p1.y + p1.height) {
            if(b.x >= p1.x && b.x <= p1.x + p1.width && b.vy < 0){
              b.vy *= -1;
            }
          }
          //  else if(b.y + b.r >= p1.y && b.y + b.r <= p2.y + p2.height) {
          //   if(b.x - b.r >= p2.x && b.x - b.r <= p2.x + p2.width){
          //     b.vy *= -1;
          //   }
          // }
          //   else if(b.y - b.r >= p1.y && b.y - b.r <= p2.y + p2.height) {
          //   if(b.x - b.r >= p1.x && b.x - b.r <= p1.x + p1.width){
          //     b.vy *= -1;
          //   }
          // }
          else if(b.x - b.r <= 0 || b.x + b.r >= W) {
            b.vx *= -1;
          }
          if(b.y + b.r < 0) {
            b.vx = 0;
            b.vy = 0;
            p1win++;
          }
          else if(b.y - b.r > H) {
            b.vy = 0;
            b.vx = 0;
            p2win++;
          }

        }

        canvas.addEventListener( "mousemove", doMouseMove, true);

        socket.on('getPlayerId', function(id){
          playerid = id;
        });

        // socket.on('playerLeft', function(id) {
        //   if(playerid > id) {
        //     playerid--;
        //   }
        //   console.log(playerid);
        // });

        function doMouseMove(e)
        {
          if(playerid % 2 == 0)
          {
        	paddle.x = e.x;
          socket.emit('movePaddle', paddle, playerid);
          }
          else if(playerid % 2 == 1)
          {
            paddle2.x = e.x;
            socket.emit('movePaddle', paddle2, playerid);
          }
        	//paddle.draw();

        }

        socket.on('updatePaddles', function(msg, pid) 
        {
          if(pid % 2 == 0)
          {
            paddle.x = msg.x;
            paddle.draw();
          }
          else if(pid % 2 == 1)
          {
            paddle2.x = msg.x;
            paddle2.draw();
          }

        })
        	
        socket.on('updateBall', function(msg){
          ball.x = msg.x;
          ball.y = msg.y;
          ball.draw();
        })

	}

	//on start

	//on mouse move
	//add a canvas event listener for mousemove


	//
	</script>
</html>